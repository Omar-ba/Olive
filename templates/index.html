<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©tection des Maladies des Feuilles d'Olivier</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(to right, #a8e063, #56ab2f);
            margin: 0;
        }

        .container {
            background: white;
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            width: 90%;
            max-width: 500px;
        }

        .logo {
            width: 180px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        p {
            color: #555;
        }

        input[type="file"] {
            margin-top: 20px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
            width: 100%;
            cursor: pointer;
        }

        .image-wrapper {
            margin-top: 20px;
            position: relative;
            width: 100%;
            height: 300px;
        }

        .placeholder {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 18px;
        }

        .preview {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            object-fit: contain;
            display: none;
        }

        video {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            display: none;
        }

        button {
            margin-top: 15px;
            padding: 12px 20px;
            font-size: 16px;
            background: #2e7d32;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover {
            background: #1b5e20;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .buttons-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            display: none;
        }

        .loading {
            display: none;
            color: #007bff;
            margin-top: 10px;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="logo.png" alt="Logo D√©tection des Maladies des Feuilles d'Olivier" class="logo">

        <p>S√©lectionnez une image ou prenez une photo pour d√©tecter une maladie :</p>

        <input type="file" id="imageInput" accept="image/*">

        <div class="image-wrapper">
            <div id="placeholder" class="placeholder">Aucune image s√©lectionn√©e</div>
            <img id="preview" class="preview" alt="Aper√ßu de l'image" />
            <video id="video" autoplay></video>
        </div>

        <div class="buttons-row">
            <button id="startCamera">Prendre une Photo</button>
            <button id="capturePhoto">Capturer</button>
        </div>

        <button id="submitBtn" onclick="submitImage()">T√©l√©verser & D√©tecter</button>

        <div id="loading" class="loading">Analyse en cours... ‚è≥</div>

        <div id="result" class="result"></div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const preview = document.getElementById('preview');
        const placeholder = document.getElementById('placeholder');
        const video = document.getElementById('video');
        const startCameraBtn = document.getElementById('startCamera');
        const capturePhotoBtn = document.getElementById('capturePhoto');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const resultDiv = document.getElementById('result');

        let stream;
        let currentImageData = null;

        // Choisir un fichier depuis l'ordinateur
        imageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = "block";
                    placeholder.style.display = "none";
                    video.style.display = "none";
                    currentImageData = e.target.result;
                    stopCamera();
                    hideResult();
                }
                reader.readAsDataURL(file);
            }
        });

        // D√©marrer la cam√©ra
        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.style.display = "block";
                preview.style.display = "none";
                placeholder.style.display = "none";
                hideResult();
            } catch (err) {
                alert("Impossible d'acc√©der √† la cam√©ra : " + err);
            }
        });

        // Capturer la photo depuis la cam√©ra
        capturePhotoBtn.addEventListener('click', () => {
            if (!stream) {
                alert("La cam√©ra n'est pas activ√©e !");
                return;
            }
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            currentImageData = canvas.toDataURL('image/png');
            preview.src = currentImageData;
            preview.style.display = "block";
            video.style.display = "none";
            stopCamera();
            hideResult();
        });

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function hideResult() {
            resultDiv.style.display = 'none';
            resultDiv.className = 'result';
        }

        function showResult(message, type) {
            resultDiv.innerHTML = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }

        async function submitImage() {
            if (!currentImageData) {
                alert("Veuillez s√©lectionner ou prendre une image d'abord !");
                return;
            }

            // Disable button and show loading
            submitBtn.disabled = true;
            loading.style.display = 'block';
            hideResult();

            try {
                const payload = {
                    image_base64: currentImageData
                };

                const response = await fetch("http://127.0.0.1:8000/predict", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    showResult(`
                        <h3>üîç R√©sultat de l'analyse :</h3>
                        <p><strong>Maladie d√©tect√©e :</strong> ${result.details.predicted_class}</p>
                        <p><strong>Confiance :</strong> ${result.details.confidence}%</p>
                        <p><strong>D√©tails :</strong></p>
                        <ul>
                            ${Object.entries(result.details.all_predictions)
                                .map(([key, value]) => `<li>${key}: ${value}%</li>`)
                                .join('')}
                        </ul>
                    `, 'success');
                } else {
                    showResult(`<strong>Erreur :</strong> ${result.error}`, 'error');
                }
            } catch (error) {
                showResult(`<strong>Erreur r√©seau :</strong> ${error.message}`, 'error');
            } finally {
                // Re-enable button and hide loading
                submitBtn.disabled = false;
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>